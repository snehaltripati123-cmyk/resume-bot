
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resume Chatbot</title>

<style>
body {
    font-family: 'Segoe UI', sans-serif;
    background: #f4f7f6;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
}

.chat-container {
    position: relative;
    width: 715px;
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    text-align: center;
}

h2 { color: #333; margin-bottom: 20px; }

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    margin: 5px;
}

.btn-blue { background: #007bff; color: white; }
.btn-dark { background: #343a40; color: white; font-size: 13px; }

#chat-box {
    height: 300px;
    overflow-y: auto;
    border: 1px solid #ddd;
    padding: 10px;
    margin-top: 20px;
    background: #fafafa;
    border-radius: 8px;
    text-align: left;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.msg { padding: 8px 12px; border-radius: 8px; max-width: 80%; font-size: 14px; }
.user { background: #007bff; color: white; align-self: flex-end; }
.bot { background: #e9ecef; color: #333; align-self: flex-start; }

input[type="text"] {
    width: 70%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    margin-top: 10px;
    outline: none;
}

/* ATS MODAL */
#atsPanel {
    position: fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background: rgba(0,0,0,0.4);
    display:none;
    justify-content:center;
    align-items:center;
    z-index:1000;
}

.ats-card {
    width:700px;
    background:white;
    padding:30px;
    border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,0.2);
    position:relative;
    text-align:center;
}
</style>
</head>

<body>

<div class="chat-container">

    <h2>Resume Chatbot</h2>

    <!-- ATS BUTTON -->
    <div style="position:absolute; top:20px; right:20px;">
        <button class="btn btn-dark" onclick="openATSPanel()">
            ATS Score Checker
        </button>
    </div>

    <input type="file" id="singleFile" accept=".pdf" style="display:none" onchange="uploadSingleFile()">
    <button class="btn btn-blue" onclick="document.getElementById('singleFile').click()">ðŸ“‚ Upload Resume</button>
    <a href="/comparison" class="btn btn-dark">Go to Comparison Mode â†’</a>

    <p id="statusMsg" style="font-size: 12px; color: green; height: 15px;"></p>

    <div id="chat-box"></div>

    <div style="display:flex; justify-content:space-between;">
        <input type="text" id="userQuery" placeholder="Ask a question..." onkeypress="handleEnter(event)">
        <button class="btn btn-blue" onclick="askBot()">Send</button>
    </div>

</div>

<!-- ATS MODAL -->
<div id="atsPanel">
    <div class="ats-card">

        <button onclick="closeATSPanel()" 
            style="position:absolute; top:15px; right:15px; border:none; background:none; font-size:18px; cursor:pointer;">
            âœ–
        </button>

        <h2>ATS Score Checker</h2>
        <p style="color:#666;">
            Upload resume and paste job description to check ATS compatibility.
        </p>

        <!-- Resume Upload -->
        <div style="margin-top:15px;">
            <input type="file" id="modalResumeFile" accept=".pdf">
        </div>

        <!-- Job Description -->
        <!-- Job Description Label -->
        <div style="text-align:left; margin-top:20px; font-weight:600;">
            Job Description
        </div>

        <textarea id="modalJDText"
            rows="6"
            placeholder="Paste Job Description here..."
            style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; margin-top:8px; box-sizing:border-box;">
        </textarea>


        <button class="btn btn-blue" style="margin-top:20px;" onclick="runModalATS()">
            Check ATS Score
        </button>

        <div id="modalATSResult" style="margin-top:20px;"></div>

    </div>
</div>

<script>

// Upload Resume (Main Chat)
async function uploadSingleFile() {
    const fileInput = document.getElementById("singleFile");
    const status = document.getElementById("statusMsg");
    if (!fileInput.files.length) return;

    const formData = new FormData();
    formData.append("resume", fileInput.files[0]);

    const res = await fetch("/upload", { method: "POST", body: formData });
    const data = await res.json();

    if (res.ok) {
        status.innerText = `âœ… ${data.filename} uploaded!`;
        addMsg("System", "Resume uploaded successfully.", "bot");
    }
}

// Chat
async function askBot() {
    const input = document.getElementById("userQuery");
    const text = input.value.trim();
    if (!text) return;

    addMsg("You", text, "user");
    input.value = "";

    const res = await fetch("/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question: text })
    });

    const data = await res.json();
    addMsg("Bot", data.answer, "bot");
}

function addMsg(sender, text, type) {
    const box = document.getElementById("chat-box");
    const div = document.createElement("div");
    div.className = `msg ${type}`;
    div.innerText = text;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}

function handleEnter(e) {
    if (e.key === "Enter") askBot();
}

// ATS MODAL
function openATSPanel() {
    document.getElementById("atsPanel").style.display = "flex";
}

function closeATSPanel() {
    document.getElementById("atsPanel").style.display = "none";
}

async function runModalATS() {
    const fileInput = document.getElementById("modalResumeFile");
    const jd = document.getElementById("modalJDText").value.trim();
    const resultDiv = document.getElementById("modalATSResult");

    if (!fileInput.files.length) {
        alert("Please upload a resume file.");
        return;
    }

    if (!jd) {
        alert("Please paste job description.");
        return;
    }

    resultDiv.innerHTML = "Uploading and analyzing...";

    try {
        const formData = new FormData();
        formData.append("resume", fileInput.files[0]);

        const uploadRes = await fetch("/upload", {
            method: "POST",
            body: formData
        });

        const uploadData = await uploadRes.json();

        if (!uploadRes.ok) {
            resultDiv.innerHTML = "<p style='color:red;'>Upload failed.</p>";
            return;
        }

        const atsRes = await fetch("/ats-score", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                resume: uploadData.text,
                job_description: jd
            })
        });

        const data = await atsRes.json();

        if (!atsRes.ok) {
            resultDiv.innerHTML = `<p style="color:red;">${data.error}</p>`;
            return;
        }

        resultDiv.innerHTML = `
            <h2>${data["ATS Score"]}%</h2>
            <p><strong>Matched:</strong> ${data["Matched Skills"].join(", ")}</p>
            <p><strong>Missing:</strong> ${data["Missing Skills"].join(", ")}</p>
        `;

    } catch (err) {
        resultDiv.innerHTML = "<p style='color:red;'>Server error.</p>";
    }
}

</script>

</body>
</html>
